{% extends "base.html" %} {% block title %}Change Password - BFP Sorsogon
Attendance System{% endblock %} {% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title"><i class="fas fa-key me-2"></i>Change Password</h1>
      <a href="{{ url_for('profile.index') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Profile
      </a>
    </div>

    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-lock me-2"></i>Update Your Password
        </h6>
      </div>
      <div class="card-body">
        <form id="changePasswordForm" method="POST">
          <div class="mb-3">
            <label for="current_password" class="form-label">
              Current Password <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="current_password"
                name="current_password"
                required
                placeholder="Enter your current password"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePassword('current_password')"
              >
                <i class="fas fa-eye" id="current_password_icon"></i>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label for="new_password" class="form-label">
              New Password <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="new_password"
                name="new_password"
                required
                placeholder="Enter your new password"
                minlength="6"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePassword('new_password')"
              >
                <i class="fas fa-eye" id="new_password_icon"></i>
              </button>
            </div>
            <div class="form-text">
              Password must be at least 6 characters long
            </div>
          </div>

          <div class="mb-3">
            <label for="confirm_password" class="form-label">
              Confirm New Password <span class="text-danger">*</span>
            </label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="confirm_password"
                name="confirm_password"
                required
                placeholder="Confirm your new password"
                minlength="6"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePassword('confirm_password')"
              >
                <i class="fas fa-eye" id="confirm_password_icon"></i>
              </button>
            </div>
          </div>

          <!-- Password Strength Indicator -->
          <div class="mb-3">
            <label class="form-label">Password Strength:</label>
            <div class="progress" style="height: 5px">
              <div
                id="passwordStrength"
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
            <small id="strengthText" class="form-text text-muted">
              Enter a new password to see strength
            </small>
          </div>

          <!-- Password Requirements -->
          <div class="mb-4">
            <small class="form-text text-muted">
              <strong>Password Requirements:</strong>
              <ul class="mt-1 mb-0">
                <li id="length-check" class="text-muted">
                  <i class="fas fa-times text-danger"></i> At least 6 characters
                </li>
                <li id="match-check" class="text-muted">
                  <i class="fas fa-times text-danger"></i> Passwords match
                </li>
              </ul>
            </small>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a
              href="{{ url_for('profile.index') }}"
              class="btn btn-secondary me-md-2"
            >
              Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="fas fa-key me-2"></i>Change Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  $(document).ready(function () {
    // Real-time password validation
    $("#new_password, #confirm_password").on("input", function () {
      validatePassword();
      checkPasswordMatch();
    });

    // Form submission
    $("#changePasswordForm").on("submit", function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      // Show loading state
      const submitBtn = $("#submitBtn");
      const originalText = submitBtn.html();
      submitBtn
        .html('<i class="fas fa-spinner fa-spin me-2"></i>Changing Password...')
        .prop("disabled", true);

      // Submit form
      const formData = new FormData(this);

      fetch("/profile/change-password", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("success", "Password changed successfully");
            setTimeout(() => {
              window.location.href = "/profile/";
            }, 2000);
          } else {
            showAlert("error", data.error || "Failed to change password");
            submitBtn.html(originalText).prop("disabled", false);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showAlert("error", "An error occurred while changing password");
          submitBtn.html(originalText).prop("disabled", false);
        });
    });
  });

  // Toggle password visibility
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + "_icon");

    if (field.type === "password") {
      field.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      field.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  // Password strength validation
  function validatePassword() {
    const password = $("#new_password").val();
    const strengthBar = $("#passwordStrength");
    const strengthText = $("#strengthText");
    const lengthCheck = $("#length-check");

    if (password.length === 0) {
      strengthBar.css("width", "0%").removeClass().addClass("progress-bar");
      strengthText.text("Enter a new password to see strength");
      lengthCheck
        .html('<i class="fas fa-times text-danger"></i> At least 6 characters')
        .removeClass("text-success")
        .addClass("text-muted");
      return;
    }

    let strength = 0;
    let strengthLabel = "";
    let strengthClass = "";

    // Length check
    if (password.length >= 6) {
      strength += 25;
      lengthCheck
        .html('<i class="fas fa-check text-success"></i> At least 6 characters')
        .removeClass("text-muted text-danger")
        .addClass("text-success");
    } else {
      lengthCheck
        .html('<i class="fas fa-times text-danger"></i> At least 6 characters')
        .removeClass("text-success text-muted")
        .addClass("text-danger");
    }

    // Additional strength checks
    if (password.length >= 8) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password) || /[^A-Za-z0-9]/.test(password)) strength += 25;

    // Set strength indicator
    if (strength < 25) {
      strengthLabel = "Very Weak";
      strengthClass = "bg-danger";
    } else if (strength < 50) {
      strengthLabel = "Weak";
      strengthClass = "bg-warning";
    } else if (strength < 75) {
      strengthLabel = "Fair";
      strengthClass = "bg-info";
    } else if (strength < 100) {
      strengthLabel = "Good";
      strengthClass = "bg-primary";
    } else {
      strengthLabel = "Strong";
      strengthClass = "bg-success";
    }

    strengthBar
      .css("width", strength + "%")
      .removeClass()
      .addClass("progress-bar " + strengthClass);
    strengthText.text("Password strength: " + strengthLabel);
  }

  // Check password match
  function checkPasswordMatch() {
    const newPassword = $("#new_password").val();
    const confirmPassword = $("#confirm_password").val();
    const matchCheck = $("#match-check");

    if (confirmPassword.length === 0) {
      matchCheck
        .html('<i class="fas fa-times text-danger"></i> Passwords match')
        .removeClass("text-success")
        .addClass("text-muted");
      return false;
    }

    if (newPassword === confirmPassword) {
      matchCheck
        .html('<i class="fas fa-check text-success"></i> Passwords match')
        .removeClass("text-muted text-danger")
        .addClass("text-success");
      return true;
    } else {
      matchCheck
        .html('<i class="fas fa-times text-danger"></i> Passwords do not match')
        .removeClass("text-success text-muted")
        .addClass("text-danger");
      return false;
    }
  }

  // Validate entire form
  function validateForm() {
    const currentPassword = $("#current_password").val();
    const newPassword = $("#new_password").val();
    const confirmPassword = $("#confirm_password").val();

    if (!currentPassword) {
      showAlert("error", "Please enter your current password");
      return false;
    }

    if (newPassword.length < 6) {
      showAlert("error", "New password must be at least 6 characters long");
      return false;
    }

    if (newPassword !== confirmPassword) {
      showAlert("error", "New passwords do not match");
      return false;
    }

    if (currentPassword === newPassword) {
      showAlert(
        "error",
        "New password must be different from current password"
      );
      return false;
    }

    return true;
  }

  // Show alert function
  function showAlert(type, message) {
    const alertClass = type === "success" ? "alert-success" : "alert-danger";
    const alertIcon =
      type === "success" ? "check-circle" : "exclamation-triangle";

    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${alertIcon} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    $(".row").first().before(alertHtml);

    setTimeout(() => {
      $(".alert").alert("close");
    }, 5000);
  }
</script>
{% endblock %}
