{% extends "base.html" %} {% block title %}Station Comparison Report - BFP
Sorsogon Attendance System{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title">
        <i class="fas fa-chart-bar me-2"></i>Station Comparison Report
      </h1>
      <div>
        <a href="{{ url_for('reports.index') }}" class="btn btn-secondary me-2">
          <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
        <button class="btn btn-success" onclick="exportComparison()">
          <i class="fas fa-download me-2"></i>Export Report
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Only Access Check -->
{% if not current_user.is_admin %}
<div class="row">
  <div class="col-12">
    <div class="alert alert-warning" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>Access Denied:</strong> Only administrators can view station
      comparison reports.
    </div>
  </div>
</div>
{% else %}

<!-- Filters -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-filter me-2"></i>Report Filters
        </h6>
      </div>
      <div class="card-body">
        <form method="GET" class="row align-items-end">
          <div class="col-md-4">
            <label for="start_date" class="form-label">Start Date:</label>
            <input
              type="date"
              class="form-control"
              id="start_date"
              name="start_date"
              value="{{ start_date }}"
              required
            />
          </div>
          <div class="col-md-4">
            <label for="end_date" class="form-label">End Date:</label>
            <input
              type="date"
              class="form-control"
              id="end_date"
              name="end_date"
              value="{{ end_date }}"
              required
            />
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-search me-2"></i>Generate Comparison
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Overall Summary -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-primary text-uppercase mb-1"
            >
              Total Stations
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ station_data | length }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-building fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-success text-uppercase mb-1"
            >
              Best Performing
            </div>
            <div class="h6 mb-0 font-weight-bold text-gray-800">
              {% set best_station = station_data |
              max(attribute='attendance_rate') %} {{
              best_station.station.station_name }}
            </div>
            <div class="text-xs text-muted">
              {{ "%.1f"|format(best_station.attendance_rate) }}%
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-trophy fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-warning text-uppercase mb-1"
            >
              Average Rate
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {% set avg_rate = (station_data |
              sum(attribute='attendance_rate')) / (station_data | length) %} {{
              "%.1f"|format(avg_rate) }}%
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              Report Period
            </div>
            <div class="h6 mb-0 font-weight-bold text-gray-800">
              {{ total_days }} Days
            </div>
            <div class="text-xs text-muted">
              {{ start_date }} to {{ end_date }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-calendar fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Station Comparison Charts -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-chart-bar me-2"></i>Station Attendance Comparison
        </h6>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="stationComparisonChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-chart-pie me-2"></i>Personnel Distribution
        </h6>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="personnelDistributionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Station Rankings -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-trophy me-2"></i>Station Performance Rankings
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for station in station_data %}
          <div class="col-lg-6 mb-4">
            <div
              class="card h-100 {% if loop.index == 1 %}border-success{% elif loop.index == station_data|length %}border-danger{% else %}border-warning{% endif %}"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-start mb-3"
                >
                  <div>
                    <h5 class="card-title mb-1">
                      {% if loop.index == 1 %}
                      <i class="fas fa-trophy text-warning me-2"></i>
                      {% elif loop.index == 2 %}
                      <i class="fas fa-medal text-secondary me-2"></i>
                      {% elif loop.index == 3 %}
                      <i class="fas fa-award text-warning me-2"></i>
                      {% endif %} {{ station.station.station_name }}
                    </h5>
                    <p class="text-muted mb-0">
                      {{ station.personnel_count }} Personnel
                    </p>
                  </div>
                  <span
                    class="badge {% if loop.index == 1 %}bg-success{% elif loop.index == station_data|length %}bg-danger{% else %}bg-warning{% endif %} fs-6"
                  >
                    #{{ loop.index }}
                  </span>
                </div>

                <div class="row text-center">
                  <div class="col-4">
                    <div class="border-end">
                      <div class="fs-4 fw-bold text-success">
                        {{ station.present_count }}
                      </div>
                      <div class="text-xs text-muted">Present</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="border-end">
                      <div class="fs-4 fw-bold text-warning">
                        {{ station.late_count }}
                      </div>
                      <div class="text-xs text-muted">Late</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="fs-4 fw-bold text-danger">
                      {{ station.expected_attendance - station.present_count }}
                    </div>
                    <div class="text-xs text-muted">Absent</div>
                  </div>
                </div>

                <hr />

                <div class="mb-2">
                  <div
                    class="d-flex justify-content-between align-items-center mb-1"
                  >
                    <span class="text-xs">Attendance Rate</span>
                    <span class="text-xs fw-bold"
                      >{{ "%.1f"|format(station.attendance_rate) }}%</span
                    >
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar {% if station.attendance_rate >= 95 %}bg-success {% elif station.attendance_rate >= 85 %}bg-warning {% else %}bg-danger{% endif %}"
                      style="width: {{ station.attendance_rate }}%"
                    ></div>
                  </div>
                </div>

                <div class="mb-0">
                  <div
                    class="d-flex justify-content-between align-items-center mb-1"
                  >
                    <span class="text-xs">Punctuality Rate</span>
                    <span class="text-xs fw-bold"
                      >{{ "%.1f"|format(station.punctuality_rate) }}%</span
                    >
                  </div>
                  <div class="progress" style="height: 8px">
                    <div
                      class="progress-bar {% if station.punctuality_rate >= 95 %}bg-success {% elif station.punctuality_rate >= 85 %}bg-warning {% else %}bg-danger{% endif %}"
                      style="width: {{ station.punctuality_rate }}%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Comparison Table -->
<div class="row">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-table me-2"></i>Detailed Station Comparison
        </h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table
            class="table table-bordered"
            id="stationComparisonTable"
            width="100%"
            cellspacing="0"
          >
            <thead>
              <tr>
                <th>Rank</th>
                <th>Station</th>
                <th>Personnel</th>
                <th>Present</th>
                <th>Late</th>
                <th>Expected</th>
                <th>Attendance Rate</th>
                <th>Punctuality Rate</th>
                <th>Performance</th>
              </tr>
            </thead>
            <tbody>
              {% for station in station_data %}
              <tr>
                <td class="text-center fw-bold">
                  {% if loop.index == 1 %}
                  <i class="fas fa-trophy text-warning"></i> {{ loop.index }} {%
                  else %} {{ loop.index }} {% endif %}
                </td>
                <td class="fw-bold">{{ station.station.station_name }}</td>
                <td class="text-center">{{ station.personnel_count }}</td>
                <td class="text-center">
                  <span class="badge bg-success"
                    >{{ station.present_count }}</span
                  >
                </td>
                <td class="text-center">
                  <span class="badge bg-warning">{{ station.late_count }}</span>
                </td>
                <td class="text-center">{{ station.expected_attendance }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <span class="me-2"
                      >{{ "%.1f"|format(station.attendance_rate) }}%</span
                    >
                    <div class="progress flex-grow-1" style="height: 8px">
                      <div
                        class="progress-bar {% if station.attendance_rate >= 95 %}bg-success {% elif station.attendance_rate >= 85 %}bg-warning {% else %}bg-danger{% endif %}"
                        style="width: {{ station.attendance_rate }}%"
                      ></div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <span class="me-2"
                      >{{ "%.1f"|format(station.punctuality_rate) }}%</span
                    >
                    <div class="progress flex-grow-1" style="height: 8px">
                      <div
                        class="progress-bar {% if station.punctuality_rate >= 95 %}bg-success {% elif station.punctuality_rate >= 85 %}bg-warning {% else %}bg-danger{% endif %}"
                        style="width: {{ station.punctuality_rate }}%"
                      ></div>
                    </div>
                  </div>
                </td>
                <td>
                  {% if station.attendance_rate >= 95 %}
                  <span class="badge bg-success">Excellent</span>
                  {% elif station.attendance_rate >= 85 %}
                  <span class="badge bg-warning">Good</span>
                  {% elif station.attendance_rate >= 75 %}
                  <span class="badge bg-primary">Fair</span>
                  {% else %}
                  <span class="badge bg-danger">Poor</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endif %} {% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  $(document).ready(function() {
      // Initialize DataTable
      $('#stationComparisonTable').DataTable({
          responsive: true,
          order: [[0, 'asc']], // Sort by rank
          pageLength: 10,
          columnDefs: [
              { orderable: false, targets: [8] } // Disable sorting for performance column
          ]
      });

      const stationNames = [
          {% for station in station_data %}
          '{{ station.station.station_name }}',
          {% endfor %}
      ];

      const attendanceRates = [
          {% for station in station_data %}
          {{ station.attendance_rate }},
          {% endfor %}
      ];

      const punctualityRates = [
          {% for station in station_data %}
          {{ station.punctuality_rate }},
          {% endfor %}
      ];

      const personnelCounts = [
          {% for station in station_data %}
          {{ station.personnel_count }},
          {% endfor %}
      ];

      // Station Comparison Chart
      const comparisonConfig = {
          type: 'bar',
          data: {
              labels: stationNames,
              datasets: [{
                  label: 'Attendance Rate (%)',
                  data: attendanceRates,
                  backgroundColor: 'rgba(54, 162, 235, 0.8)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
              }, {
                  label: 'Punctuality Rate (%)',
                  data: punctualityRates,
                  backgroundColor: 'rgba(255, 99, 132, 0.8)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  title: {
                      display: true,
                      text: 'Station Performance Comparison'
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      max: 100,
                      ticks: {
                          callback: function(value) {
                              return value + '%';
                          }
                      }
                  }
              }
          }
      };

      // Personnel Distribution Chart
      const distributionConfig = {
          type: 'doughnut',
          data: {
              labels: stationNames,
              datasets: [{
                  data: personnelCounts,
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.8)',
                      'rgba(54, 162, 235, 0.8)',
                      'rgba(255, 205, 86, 0.8)',
                      'rgba(75, 192, 192, 0.8)',
                      'rgba(153, 102, 255, 0.8)'
                  ],
                  borderColor: [
                      'rgba(255, 99, 132, 1)',
                      'rgba(54, 162, 235, 1)',
                      'rgba(255, 205, 86, 1)',
                      'rgba(75, 192, 192, 1)',
                      'rgba(153, 102, 255, 1)'
                  ],
                  borderWidth: 2
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  title: {
                      display: true,
                      text: 'Personnel by Station'
                  },
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      };

      // Initialize Charts
      new Chart(document.getElementById('stationComparisonChart'), comparisonConfig);
      new Chart(document.getElementById('personnelDistributionChart'), distributionConfig);
  });

  // Export function
  function exportComparison() {
      window.print();
  }
</script>
{% endblock %}
