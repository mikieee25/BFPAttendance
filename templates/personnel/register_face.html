{% extends "base.html" %} {% block title %}Register Face - {{
personnel.full_name }} - BFP Sorsogon Attendance System{% endblock %} {% block
content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title">
        <i class="fas fa-camera me-2"></i>Face Registration
      </h1>
      <div class="btn-group">
        <a
          href="{{ url_for('personnel.view', personnel_id=personnel.id) }}"
          class="btn btn-secondary"
        >
          <i class="fas fa-eye me-2"></i>View Details
        </a>
        <a
          href="{{ url_for('personnel.index') }}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-lg-10">
    <!-- Personnel Information -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            {% if personnel.image_path %}
            <img
              src="{{ url_for('static', filename=personnel.image_path) }}"
              alt="{{ personnel.full_name }}"
              class="rounded-circle"
              width="60"
              height="60"
              style="object-fit: cover"
            />
            {% else %}
            <img
              src="{{ url_for('static', filename='images/profile-placeholder.jpg') }}"
              alt="No Photo"
              class="rounded-circle"
              width="60"
              height="60"
              style="object-fit: cover"
            />
            {% endif %}
          </div>
          <div class="col">
            <h5 class="mb-1">{{ personnel.full_name }}</h5>
            <p class="text-muted mb-0">
              {{ personnel.rank }} - {{ personnel.station.station_name if
              personnel.station else 'Unknown Station' }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Face Registration Interface -->
    <div class="card">
      <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-camera me-2"></i>Face Registration System
        </h6>
      </div>
      <div class="card-body">
        <!-- Instructions -->
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Instructions:</strong>
          <ul class="mb-0 mt-2">
            <li>Position your face clearly in the camera view</li>
            <li>Ensure good lighting and remove glasses if possible</li>
            <li>Look directly at the camera</li>
            <li>Multiple angles will be captured for better recognition</li>
          </ul>
        </div>

        <!-- Camera Interface -->
        <div class="row">
          <div class="col-lg-8">
            <div class="camera-container text-center">
              <div id="cameraStatus" class="mb-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading camera...</span>
                </div>
                <p class="mt-2">Initializing camera...</p>
              </div>

              <video
                id="video"
                width="640"
                height="480"
                autoplay
                muted
                style="
                  display: none;
                  border: 3px solid #007bff;
                  border-radius: 8px;
                "
              ></video>
              <canvas
                id="canvas"
                width="640"
                height="480"
                style="display: none"
              ></canvas>

              <div
                id="cameraError"
                class="alert alert-danger"
                style="display: none"
              >
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage"></span>
              </div>
            </div>

            <!-- Camera Controls -->
            <div
              class="text-center mt-3"
              id="cameraControls"
              style="display: none"
            >
              <button type="button" class="btn btn-bfp btn-lg" id="captureBtn">
                <i class="fas fa-camera me-2"></i>Capture Face
              </button>
              <button
                type="button"
                class="btn btn-secondary ms-2"
                id="switchCameraBtn"
                style="display: none"
              >
                <i class="fas fa-sync me-2"></i>Switch Camera
              </button>
            </div>
          </div>

          <div class="col-lg-4">
            <!-- Registration Progress -->
            <div class="card">
              <div class="card-header">
                <h6 class="m-0 font-weight-bold text-success">
                  <i class="fas fa-list-check me-2"></i>Registration Progress
                </h6>
              </div>
              <div class="card-body">
                <div class="progress mb-3">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    id="progressBar"
                    style="width: 0%"
                  >
                    0%
                  </div>
                </div>
                <div id="capturedFaces">
                  <p class="text-muted">No faces captured yet</p>
                </div>

                <div class="d-grid gap-2 mt-3">
                  <button
                    type="button"
                    class="btn btn-success"
                    id="completeBtn"
                    style="display: none"
                    disabled
                  >
                    <i class="fas fa-check me-2"></i>Complete Registration
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="resetBtn"
                    style="display: none"
                  >
                    <i class="fas fa-redo me-2"></i>Reset Captures
                  </button>
                </div>
              </div>
            </div>

            <!-- Tips -->
            <div class="card mt-3">
              <div class="card-header">
                <h6 class="m-0 font-weight-bold text-info">
                  <i class="fas fa-lightbulb me-2"></i>Tips for Better
                  Recognition
                </h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled mb-0">
                  <li>
                    <i class="fas fa-check text-success me-2"></i>Good lighting
                  </li>
                  <li>
                    <i class="fas fa-check text-success me-2"></i>Face directly
                    toward camera
                  </li>
                  <li>
                    <i class="fas fa-check text-success me-2"></i>Remove glasses
                    if possible
                  </li>
                  <li>
                    <i class="fas fa-check text-success me-2"></i>Neutral
                    expression
                  </li>
                  <li>
                    <i class="fas fa-check text-success me-2"></i>Capture 3-5
                    different angles
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div
  class="modal fade"
  id="successModal"
  tabindex="-1"
  aria-labelledby="successModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="successModalLabel">
          <i class="fas fa-check-circle text-success me-2"></i>Registration
          Successful
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <i
            class="fas fa-check-circle text-success"
            style="font-size: 3rem"
          ></i>
          <h4 class="mt-3">Face Registration Complete!</h4>
          <p class="text-muted">
            {{ personnel.full_name }} can now use the attendance system.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <a
          href="{{ url_for('personnel.view', personnel_id=personnel.id) }}"
          class="btn btn-bfp"
        >
          <i class="fas fa-eye me-2"></i>View Personnel
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  let video;
  let canvas;
  let stream;
  let capturedFaces = [];
  let currentCamera = 0;
  let cameras = [];

  // Initialize camera when page loads
  document.addEventListener("DOMContentLoaded", function () {
    initializeCamera();
    setupEventListeners();
  });

  async function initializeCamera() {
    try {
      // Check if browser supports getUserMedia
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error("Camera access is not supported in this browser");
      }

      // First request basic camera access to trigger permission prompt
      try {
        const testStream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        testStream.getTracks().forEach((track) => track.stop());
      } catch (permissionError) {
        throw new Error(
          "Camera permission denied. Please allow camera access and refresh the page."
        );
      }

      // Get available cameras after permission is granted
      const devices = await navigator.mediaDevices.enumerateDevices();
      cameras = devices.filter((device) => device.kind === "videoinput");

      if (cameras.length === 0) {
        throw new Error("No cameras found on this device");
      }

      // Show switch camera button if multiple cameras
      if (cameras.length > 1) {
        document.getElementById("switchCameraBtn").style.display =
          "inline-block";
      }

      // Start camera
      await startCamera();
    } catch (error) {
      console.error("Error initializing camera:", error);
      showCameraError(error.message);
    }
  }

  async function startCamera() {
    try {
      // Stop existing stream
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
      }

      // Request camera access with flexible constraints
      let constraints = {
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "user", // Prefer front camera
        },
      };

      // If we have specific cameras and a selected one, try to use it
      if (cameras.length > 0 && cameras[currentCamera]) {
        constraints.video.deviceId = { ideal: cameras[currentCamera].deviceId };
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (error) {
        // If specific device fails, try with basic constraints
        console.warn(
          "Failed with specific device, trying basic constraints:",
          error
        );
        constraints = {
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
          },
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }

      // Setup video element
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");

      video.srcObject = stream;
      video.style.display = "block";
      document.getElementById("cameraStatus").style.display = "none";
      document.getElementById("cameraControls").style.display = "block";
    } catch (error) {
      console.error("Error starting camera:", error);

      let errorMessage = "Failed to access camera. ";

      if (error.name === "NotAllowedError") {
        errorMessage +=
          "Camera permission denied. Please allow camera access and refresh the page.";
      } else if (error.name === "NotFoundError") {
        errorMessage += "No camera found on this device.";
      } else if (error.name === "OverconstrainedError") {
        errorMessage +=
          "Camera constraints could not be satisfied. Trying again with basic settings...";
        // Try one more time with very basic constraints
        setTimeout(async () => {
          try {
            const basicConstraints = { video: true };
            stream = await navigator.mediaDevices.getUserMedia(
              basicConstraints
            );
            video = document.getElementById("video");
            video.srcObject = stream;
            video.style.display = "block";
            document.getElementById("cameraError").style.display = "none";
            document.getElementById("cameraControls").style.display = "block";
          } catch (basicError) {
            showCameraError(
              "Camera access failed completely. Please check your camera and permissions."
            );
          }
        }, 1000);
        return;
      } else if (error.name === "NotReadableError") {
        errorMessage += "Camera is already in use by another application.";
      } else {
        errorMessage +=
          "Please ensure camera permissions are granted and try refreshing the page.";
      }

      showCameraError(errorMessage);
    }
  }

  function showCameraError(message) {
    document.getElementById("cameraStatus").style.display = "none";
    document.getElementById("cameraError").style.display = "block";
    document.getElementById("errorMessage").textContent = message;
  }

  function setupEventListeners() {
    // Capture button
    document
      .getElementById("captureBtn")
      .addEventListener("click", captureFrame);

    // Switch camera button
    document
      .getElementById("switchCameraBtn")
      .addEventListener("click", async function () {
        try {
          currentCamera = (currentCamera + 1) % cameras.length;
          await startCamera();
        } catch (error) {
          console.error("Error switching camera:", error);
          // Reset to first camera if switching fails
          currentCamera = 0;
          try {
            await startCamera();
          } catch (fallbackError) {
            showCameraError(
              "Failed to switch camera. Please refresh the page."
            );
          }
        }
      });

    // Complete registration button
    document
      .getElementById("completeBtn")
      .addEventListener("click", completeRegistration);

    // Reset button
    document
      .getElementById("resetBtn")
      .addEventListener("click", resetCaptures);
  }

  async function captureFrame() {
    if (!video || !canvas) return;

    const context = canvas.getContext("2d");
    context.drawImage(video, 0, 0, 640, 480);

    // Convert to blob
    canvas.toBlob(
      async function (blob) {
        try {
          // Create form data
          const formData = new FormData();
          formData.append("image", blob, "capture.jpg");

          // Show loading state
          const captureBtn = document.getElementById("captureBtn");
          const originalText = captureBtn.innerHTML;
          captureBtn.disabled = true;
          captureBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

          // Send to server
          const response = await fetch(
            "{{ url_for('personnel.api_register_face', personnel_id=personnel.id) }}",
            {
              method: "POST",
              body: formData,
            }
          );

          const result = await response.json();

          if (result.success) {
            addCapturedFace();
            updateProgress();
          } else {
            alert("Error: " + result.error);
          }
        } catch (error) {
          console.error("Error capturing face:", error);
          alert("Error processing face capture");
        } finally {
          // Restore button
          const captureBtn = document.getElementById("captureBtn");
          captureBtn.disabled = false;
          captureBtn.innerHTML =
            '<i class="fas fa-camera me-2"></i>Capture Face';
        }
      },
      "image/jpeg",
      0.8
    );
  }

  function addCapturedFace() {
    capturedFaces.push(Date.now());

    const container = document.getElementById("capturedFaces");
    if (capturedFaces.length === 1) {
      container.innerHTML = "";
    }

    const faceDiv = document.createElement("div");
    faceDiv.className = "mb-2";
    faceDiv.innerHTML = `
        <i class="fas fa-check-circle text-success me-2"></i>
        Face ${capturedFaces.length} captured
    `;
    container.appendChild(faceDiv);
  }

  function updateProgress() {
    const progress = Math.min((capturedFaces.length / 3) * 100, 100);
    const progressBar = document.getElementById("progressBar");
    progressBar.style.width = progress + "%";
    progressBar.textContent = Math.round(progress) + "%";

    // Show complete button if enough faces captured
    if (capturedFaces.length >= 3) {
      document.getElementById("completeBtn").style.display = "block";
      document.getElementById("completeBtn").disabled = false;
      document.getElementById("resetBtn").style.display = "block";
    }
  }

  function resetCaptures() {
    capturedFaces = [];
    document.getElementById("capturedFaces").innerHTML =
      '<p class="text-muted">No faces captured yet</p>';
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("progressBar").textContent = "0%";
    document.getElementById("completeBtn").style.display = "none";
    document.getElementById("resetBtn").style.display = "none";
  }

  async function completeRegistration() {
    try {
      const completeBtn = document.getElementById("completeBtn");
      const originalText = completeBtn.innerHTML;
      completeBtn.disabled = true;
      completeBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Completing...';

      // Stop camera
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
      }

      // Show success modal
      const modal = new bootstrap.Modal(
        document.getElementById("successModal")
      );
      modal.show();
    } catch (error) {
      console.error("Error completing registration:", error);
      alert("Error completing registration");
    }
  }

  // Cleanup when leaving page
  window.addEventListener("beforeunload", function () {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
    }
  });
</script>

{% endblock %}
