{% extends "base.html" %} 
{% block title %}Edit {{ personnel.full_name }} - BFP Sorsogon Attendance System{% endblock %} 
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title">
        <i class="fas fa-user-edit me-2"></i>Edit Personnel
      </h1>
      <div class="btn-group">
        <a href="{{ url_for('personnel.view', personnel_id=personnel.id) }}" class="btn btn-secondary">
          <i class="fas fa-eye me-2"></i>View Details
        </a>
        <a href="{{ url_for('personnel.index') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-user-edit me-2"></i>Edit Personnel Information
        </h6>
      </div>
      <div class="card-body">
        <form id="editPersonnelForm" method="POST" enctype="multipart/form-data">
          <div class="row">
            <!-- Current Photo Display -->
            <div class="col-12 text-center mb-4">
              <div class="current-photo">
                {% if personnel.image_path %}
                <img
                  src="{{ url_for('static', filename=personnel.image_path) }}"
                  alt="{{ personnel.full_name }}"
                  class="rounded-circle"
                  width="120"
                  height="120"
                  style="object-fit: cover;"
                />
                {% else %}
                <img
                  src="{{ url_for('static', filename='images/profile-placeholder.jpg') }}"
                  alt="No Photo"
                  class="rounded-circle"
                  width="120"
                  height="120"
                  style="object-fit: cover;"
                />
                {% endif %}
                <div class="mt-2">
                  <small class="text-muted">Current Photo</small>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="first_name" class="form-label">
                  First Name <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="first_name"
                  name="first_name"
                  value="{{ personnel.first_name }}"
                  required
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="last_name" class="form-label">
                  Last Name <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="last_name"
                  name="last_name"
                  value="{{ personnel.last_name }}"
                  required
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="rank" class="form-label">
                  Rank <span class="text-danger">*</span>
                </label>
                <select class="form-control" id="rank" name="rank" required>
                  <option value="">Select Rank</option>
                  <option value="Fire Officer I" {% if personnel.rank == 'Fire Officer I' %}selected{% endif %}>Fire Officer I</option>
                  <option value="Fire Officer II" {% if personnel.rank == 'Fire Officer II' %}selected{% endif %}>Fire Officer II</option>
                  <option value="Fire Officer III" {% if personnel.rank == 'Fire Officer III' %}selected{% endif %}>Fire Officer III</option>
                  <option value="Senior Fire Officer I" {% if personnel.rank == 'Senior Fire Officer I' %}selected{% endif %}>Senior Fire Officer I</option>
                  <option value="Senior Fire Officer II" {% if personnel.rank == 'Senior Fire Officer II' %}selected{% endif %}>Senior Fire Officer II</option>
                  <option value="Senior Fire Officer III" {% if personnel.rank == 'Senior Fire Officer III' %}selected{% endif %}>Senior Fire Officer III</option>
                  <option value="Senior Fire Officer IV" {% if personnel.rank == 'Senior Fire Officer IV' %}selected{% endif %}>Senior Fire Officer IV</option>
                  <option value="Chief Fire Officer" {% if personnel.rank == 'Chief Fire Officer' %}selected{% endif %}>Chief Fire Officer</option>
                  <option value="Fire Chief" {% if personnel.rank == 'Fire Chief' %}selected{% endif %}>Fire Chief</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="station_id" class="form-label">
                  Station <span class="text-danger">*</span>
                </label>
                <select class="form-control" id="station_id" name="station_id" required>
                  <option value="">Select Station</option>
                  {% for station in stations %}
                  <option value="{{ station.id }}" {% if personnel.station_id == station.id %}selected{% endif %}>
                    {{ station.station_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="mb-3">
                <label for="image" class="form-label">
                  Update Profile Photo
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="image"
                  name="image"
                  accept="image/*"
                />
                <small class="form-text text-muted">
                  Leave empty to keep current photo. Upload a new photo to replace it.
                </small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> If you update the profile photo, you may need to re-register the face encodings for attendance recognition.
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary me-md-2" onclick="window.location.href='{{ url_for('personnel.view', personnel_id=personnel.id) }}'">
                  <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="submit" class="btn btn-bfp">
                  <i class="fas fa-save me-2"></i>Update Personnel
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="card mt-4 border-danger">
      <div class="card-header bg-danger text-white">
        <h6 class="m-0 font-weight-bold">
          <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
        </h6>
      </div>
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h6 class="text-danger">Delete Personnel</h6>
            <p class="text-muted mb-0">
              Permanently delete this personnel record. This action cannot be undone and will remove all associated attendance records.
            </p>
          </div>
          <div class="col-md-4 text-end">
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
              <i class="fas fa-trash me-2"></i>Delete Personnel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ personnel.full_name }}</strong>?</p>
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-warning me-2"></i>
          <strong>This action cannot be undone!</strong> All attendance records for this personnel will also be permanently deleted.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash me-2"></i>Delete Personnel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Handle form submission
document.getElementById('editPersonnelForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    
    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Check if response is JSON or redirect
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                if (result.success) {
                    window.location.href = "{{ url_for('personnel.view', personnel_id=personnel.id) }}";
                } else {
                    alert('Error: ' + result.error);
                }
            } else {
                // Redirect response
                window.location.reload();
            }
        } else {
            alert('An error occurred while updating personnel.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating personnel.');
    } finally {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Handle delete confirmation
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    const deleteBtn = this;
    const originalText = deleteBtn.innerHTML;
    
    // Show loading state
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
    
    try {
        const response = await fetch("{{ url_for('personnel.delete', personnel_id=personnel.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            window.location.href = "{{ url_for('personnel.index') }}";
        } else {
            alert('An error occurred while deleting personnel.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting personnel.');
    } finally {
        // Restore button state
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    }
});
</script>

{% endblock %}
