{% extends "base.html" %} {% block title %}Attendance Capture - BFP Sorsogon
Attendance System{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="page-title">
      <i class="fas fa-camera me-2"></i>Capture Attendance
    </h1>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-camera me-2"></i>Face Recognition Attendance
        </h6>
      </div>
      <div class="card-body">
        <div class="text-center">
          <div id="camera-container">
            <video
              id="video"
              width="640"
              height="480"
              autoplay
              style="max-width: 100%; height: auto; border-radius: 0.5rem"
            ></video>
            <canvas
              id="canvas"
              width="640"
              height="480"
              style="display: none"
            ></canvas>
          </div>

          <div class="mt-3">
            <button id="captureBtn" class="btn btn-bfp btn-lg">
              <i class="fas fa-camera me-2"></i>Capture Attendance
            </button>
            <button
              id="retryBtn"
              class="btn btn-secondary btn-lg ms-2"
              style="display: none"
            >
              <i class="fas fa-redo me-2"></i>Retry
            </button>
          </div>

          <div id="status" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-check-circle me-2"></i>Attendance Recorded
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="successMessage">
        <!-- Success message will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-circle me-2"></i>Error
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="errorMessage">
        <!-- Error message will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let video, canvas, ctx;
  let stream = null;

  async function initCamera() {
    try {
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext("2d");

      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: 640,
          height: 480,
          facingMode: "user",
        },
      });

      video.srcObject = stream;

      document.getElementById("status").innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Camera ready. Position your face in the frame and click "Capture Attendance".
            </div>
        `;
    } catch (error) {
      console.error("Error accessing camera:", error);
      document.getElementById("status").innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error accessing camera: ${error.message}
            </div>
        `;
    }
  }

  function captureImage() {
    ctx.drawImage(video, 0, 0, 640, 480);
    return canvas.toDataURL("image/jpeg", 0.8);
  }

  async function processAttendance(imageData) {
    try {
      const response = await fetch('{{ url_for("api.capture_attendance") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          image: imageData,
        }),
      });

      const result = await response.json();

      if (result.success) {
        if (result.action === "time_in") {
          document.getElementById("successMessage").innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user-check fa-3x text-success mb-3"></i>
                        <h5>${result.personnel.name}</h5>
                        <p class="mb-2"><strong>Time In:</strong> ${
                          result.time
                        }</p>
                        <p class="mb-2"><strong>Status:</strong> 
                            <span class="badge bg-${
                              result.status === "PRESENT"
                                ? "success"
                                : "warning"
                            }">${result.status}</span>
                        </p>
                        <p class="mb-0"><strong>Station:</strong> ${
                          result.personnel.station
                        }</p>
                    </div>
                `;
          new bootstrap.Modal(document.getElementById("successModal")).show();
        } else if (result.action === "time_out") {
          document.getElementById("successMessage").innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user-clock fa-3x text-info mb-3"></i>
                        <h5>${result.personnel.name}</h5>
                        <p class="mb-2"><strong>Time Out:</strong> ${result.time}</p>
                        <p class="mb-0"><strong>Station:</strong> ${result.personnel.station}</p>
                    </div>
                `;
          new bootstrap.Modal(document.getElementById("successModal")).show();
        } else if (result.action === "already_recorded") {
          document.getElementById("errorMessage").innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-info-circle fa-2x text-info mb-3"></i>
                        <h5>${result.personnel.name}</h5>
                        <p>${result.message}</p>
                        ${
                          result.time_in
                            ? `<p><strong>Time In:</strong> ${result.time_in}</p>`
                            : ""
                        }
                        ${
                          result.time_out
                            ? `<p><strong>Time Out:</strong> ${result.time_out}</p>`
                            : ""
                        }
                    </div>
                `;
          new bootstrap.Modal(document.getElementById("errorModal")).show();
        } else if (result.action === "cooldown") {
          document.getElementById("errorMessage").innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <h5>${result.personnel.name}</h5>
                        <p>${result.message}</p>
                    </div>
                `;
          new bootstrap.Modal(document.getElementById("errorModal")).show();
        }
      } else {
        document.getElementById("errorMessage").innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <p>${result.error}</p>
                </div>
            `;
        new bootstrap.Modal(document.getElementById("errorModal")).show();
      }
    } catch (error) {
      console.error("Error processing attendance:", error);
      document.getElementById("errorMessage").innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                <p>Error processing attendance: ${error.message}</p>
            </div>
        `;
      new bootstrap.Modal(document.getElementById("errorModal")).show();
    }
  }

  document
    .getElementById("captureBtn")
    .addEventListener("click", async function () {
      const button = this;
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

      try {
        const imageData = captureImage();
        await processAttendance(imageData);
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("errorMessage").innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                <p>Error capturing attendance: ${error.message}</p>
            </div>
        `;
        new bootstrap.Modal(document.getElementById("errorModal")).show();
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    });

  document.getElementById("retryBtn").addEventListener("click", function () {
    location.reload();
  });

  // Initialize camera when page loads
  document.addEventListener("DOMContentLoaded", function () {
    initCamera();
  });

  // Cleanup camera when leaving page
  window.addEventListener("beforeunload", function () {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
    }
  });
</script>
{% endblock %}
