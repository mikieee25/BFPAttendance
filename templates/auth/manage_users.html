{% extends "base.html" %} {% block title %}Manage Users - BFP Sorsogon
Attendance System{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title"><i class="fas fa-users me-2"></i>Manage Users</h1>
      <div>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary">
          <i class="fas fa-user-plus me-2"></i>Add New Personnel
        </a>
        <button class="btn btn-success" onclick="exportUsers()">
          <i class="fas fa-download me-2"></i>Export
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Overview -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-primary text-uppercase mb-1"
            >
              Total Personnel
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ user_stats.total_users }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-users fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-success text-uppercase mb-1"
            >
              Active Users
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ user_stats.active_users }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-user-check fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-warning text-uppercase mb-1"
            >
              Administrators
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ user_stats.admin_users }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-user-shield fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              New This Month
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ user_stats.new_this_month }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-user-plus fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-body">
        <div class="row align-items-end">
          <div class="col-md-3">
            <label for="filterStation" class="form-label"
              >Filter by Station:</label
            >
            <select class="form-select" id="filterStation">
              <option value="">All Stations</option>
              {% for station in stations %}
              <option value="{{ station.id }}">
                {{ station.station_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="filterRank" class="form-label">Filter by Rank:</label>
            <select class="form-select" id="filterRank">
              <option value="">All Ranks</option>
              <option value="Fire Chief">Fire Chief</option>
              <option value="Asst. Fire Chief">Asst. Fire Chief</option>
              <option value="Fire Superintendent">Fire Superintendent</option>
              <option value="Fire Inspector">Fire Inspector</option>
              <option value="Senior Fire Officer">Senior Fire Officer</option>
              <option value="Fire Officer">Fire Officer</option>
              <option value="Senior Firefighter">Senior Firefighter</option>
              <option value="Firefighter">Firefighter</option>
              <option value="Probationary Firefighter">
                Probationary Firefighter
              </option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filterStatus" class="form-label"
              >Filter by Status:</label
            >
            <select class="form-select" id="filterStatus">
              <option value="">All Status</option>
              <option value="ACTIVE">Active</option>
              <option value="INACTIVE">Inactive</option>
              <option value="ON_LEAVE">On Leave</option>
              <option value="SUSPENDED">Suspended</option>
            </select>
          </div>
          <div class="col-md-3">
            <button
              class="btn btn-outline-secondary w-100"
              onclick="clearFilters()"
            >
              <i class="fas fa-times me-2"></i>Clear Filters
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Users Table -->
<div class="row">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-list me-2"></i>Personnel List
        </h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table
            class="table table-bordered"
            id="usersTable"
            width="100%"
            cellspacing="0"
          >
            <thead>
              <tr>
                <th>Photo</th>
                <th>Username</th>
                <th>Station</th>
                <th>-</th>
                <th>Station Type</th>
                <th>Email</th>
                <th>-</th>
                <th>Status</th>
                <th>Role</th>
                <th>Created Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>
                  <img
                    src="{{ url_for('static', filename=user.profile_picture) }}"
                    alt="Profile"
                    class="rounded-circle"
                    width="40"
                    height="40"
                    style="object-fit: cover"
                  />
                </td>
                <td>
                  <div class="fw-bold">{{ user.username }}</div>
                  <div class="text-sm text-muted">{{ user.email }}</div>
                </td>
                <td>{{ user.station_name }}</td>
                <td>-</td>
                <td>{{ user.station_name }}</td>
                <td>{{ user.email }}</td>
                <td>-</td>
                <td>
                  <span class="badge bg-success">Active</span>
                </td>
                <td>
                  <span
                    class="badge bg-{{ 'danger' if user.is_admin else 'primary' }}"
                  >
                    {{ 'Administrator' if user.is_admin else 'User' }}
                  </span>
                </td>
                <td>
                  {{ user.date_created.strftime('%m/%d/%Y') if user.date_created
                  else '-' }}
                </td>
                <td>
                  <div class="btn-group" role="group">
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="viewUser({{ user.id }})"
                      title="View Details"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-success"
                      onclick="editUser({{ user.id }})"
                      title="Edit User"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    {% if not user.is_admin or user.id != current_user.id %}
                    <button
                      class="btn btn-sm btn-outline-warning"
                      onclick="toggleUserStatus({{ user.id }})"
                      title="Toggle Status"
                    >
                      <i
                        class="fas fa-{{ 'unlock' if user.status and user.status.name == 'ACTIVE' else 'lock' }}"
                      ></i>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      onclick="deleteUser({{ user.id }})"
                      title="Delete User"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Personnel Details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="userDetailsContent">
        <!-- Content will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="editUserFromModal()"
        >
          Edit User
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Personnel</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="editUserContent">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentUserId = null;

  // Initialize DataTable
  $(document).ready(function () {
    const table = $("#usersTable").DataTable({
      responsive: true,
      order: [[1, "asc"]], // Sort by name
      pageLength: 25,
      columnDefs: [
        { orderable: false, targets: [0, 10] }, // Disable sorting for photo and actions columns
        { searchable: false, targets: [0, 10] },
      ],
    });

    // Add filter functionality
    $("#filterStation, #filterRank, #filterStatus").on("change", function () {
      applyFilters(table);
    });
  });

  // Apply filters
  function applyFilters(table) {
    const station = $("#filterStation").val();
    const rank = $("#filterRank").val();
    const status = $("#filterStatus").val();

    // Clear previous search
    table.search("").columns().search("").draw();

    // Apply column-specific filters
    if (station) {
      table.column(4).search(station).draw();
    }
    if (rank) {
      table.column(2).search(rank).draw();
    }
    if (status) {
      table.column(7).search(status).draw();
    }
  }

  // Clear all filters
  function clearFilters() {
    $("#filterStation, #filterRank, #filterStatus").val("");
    $("#usersTable").DataTable().search("").columns().search("").draw();
  }

  // View user details
  function viewUser(userId) {
    fetch(`/auth/user/${userId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          currentUserId = userId;
          $("#userDetailsContent").html(data.html);
          $("#userDetailsModal").modal("show");
        } else {
          showAlert("error", "Failed to load user details");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showAlert("error", "An error occurred while loading user details");
      });
  }

  // Edit user
  function editUser(userId) {
    fetch(`/auth/user/${userId}/edit`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          currentUserId = userId;
          $("#editUserContent").html(data.html);
          $("#editUserModal").modal("show");
        } else {
          showAlert("error", "Failed to load edit form");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showAlert("error", "An error occurred while loading edit form");
      });
  }

  // Edit user from details modal
  function editUserFromModal() {
    $("#userDetailsModal").modal("hide");
    setTimeout(() => editUser(currentUserId), 300);
  }

  // Toggle user status
  function toggleUserStatus(userId) {
    if (confirm("Are you sure you want to change this user's status?")) {
      fetch(`/auth/user/${userId}/toggle-status`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("success", data.message);
            setTimeout(() => location.reload(), 1500);
          } else {
            showAlert("error", data.error);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showAlert("error", "An error occurred while updating user status");
        });
    }
  }

  // Delete user
  function deleteUser(userId) {
    if (
      confirm(
        "Are you sure you want to delete this user? This action cannot be undone."
      )
    ) {
      fetch(`/auth/user/${userId}/delete`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("success", data.message);
            setTimeout(() => location.reload(), 1500);
          } else {
            showAlert("error", data.error);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showAlert("error", "An error occurred while deleting user");
        });
    }
  }

  // Export users
  function exportUsers() {
    const filters = {
      station: $("#filterStation").val(),
      rank: $("#filterRank").val(),
      status: $("#filterStatus").val(),
    };

    const queryString = new URLSearchParams(filters).toString();
    window.open(`/auth/export-users?${queryString}`, "_blank");
  }

  // Show alert function
  function showAlert(type, message) {
    const alertClass = type === "success" ? "alert-success" : "alert-danger";
    const alertIcon =
      type === "success" ? "check-circle" : "exclamation-triangle";

    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${alertIcon} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    $(".row").first().before(alertHtml);

    setTimeout(() => {
      $(".alert").alert("close");
    }, 5000);
  }
</script>
{% endblock %}
